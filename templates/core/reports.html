{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>التقارير</title>

  <!-- Dark Mode مبكراً -->
  <script>
    (function () {
      try {
        if (localStorage.getItem('unibooking.dark') === '1') {
          document.documentElement.classList.add('dark');
        }
      } catch (e) {}
    })();
  </script>
  <!-- Tailwind config -->
  <script>
    window.tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Tajawal", "Noto Kufi Arabic", Arial, sans-serif; }
    .card { background:#fff; border-radius:.75rem; padding:1rem; box-shadow:0 1px 2px rgba(0,0,0,.06),0 1px 3px rgba(0,0,0,.1); }
    .dark .card { background:#111827; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-950 text-gray-900 dark:text-gray-100 p-6">

  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold">التقارير</h1>
    <div class="flex items-center gap-3">
      <a href="{% url 'dashboard' %}" class="text-sm px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-800 hover:opacity-90">الرجوع للداشبورد</a>
      <button id="darkToggle" class="text-sm px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-800 hover:opacity-90">المظهر الداكن</button>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="card mb-4">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div>
        <label class="block text-sm mb-1">من تاريخ</label>
        <input type="date" name="from" value="{{ q_from }}" class="w-full px-3 py-2 rounded-md bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
      </div>
      <div>
        <label class="block text-sm mb-1">إلى تاريخ</label>
        <input type="date" name="to" value="{{ q_to }}" class="w-full px-3 py-2 rounded-md bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
      </div>
      <div>
        <label class="block text-sm mb-1">الموظف</label>
        <input type="text" name="employee" value="{{ q_employee }}" placeholder="اسم الموظف" class="w-full px-3 py-2 rounded-md bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
      </div>
      <div>
        <label class="block text-sm mb-1">نوع الحجز</label>
        <select name="kind" class="w-full px-3 py-2 rounded-md bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
          <option value="" {% if q_kind == "" %}selected{% endif %}>الكل</option>
          <option value="hotel" {% if q_kind == "hotel" %}selected{% endif %}>فنادق</option>
          <option value="flight" {% if q_kind == "flight" %}selected{% endif %}>طيران</option>
          <option value="transfer" {% if q_kind == "transfer" %}selected{% endif %}>ترانسفير</option>
          <option value="visa" {% if q_kind == "visa" %}selected{% endif %}>فيزا</option>
        </select>
      </div>
      <div class="flex items-end">
        <button class="w-full px-3 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white">تطبيق</button>
      </div>
    </div>
  </form>

  <!-- Export Buttons -->
  <div class="card mb-6">
    <div class="flex flex-wrap items-center gap-3">
      <a class="px-3 py-2 rounded-md bg-gray-200 dark:bg-gray-800 hover:opacity-90"
         href="{% url 'reports_export_csv' %}?from={{ q_from }}&to={{ q_to }}&employee={{ q_employee }}&kind={{ q_kind }}">تصدير CSV</a>
      <a class="px-3 py-2 rounded-md bg-gray-200 dark:bg-gray-800 hover:opacity-90"
         href="{% url 'reports_export_xlsx' %}?from={{ q_from }}&to={{ q_to }}&employee={{ q_employee }}&kind={{ q_kind }}">تصدير Excel</a>
      <a class="px-3 py-2 rounded-md bg-gray-200 dark:bg-gray-800 hover:opacity-90"
         href="{% url 'reports_export_pdf' %}?from={{ q_from }}&to={{ q_to }}&employee={{ q_employee }}&kind={{ q_kind }}">تصدير PDF</a>
    </div>
  </div>

  <!-- Chart -->
  <div class="card mb-6 h-80">
    <h3 class="font-semibold mb-3">عدد الحجوزات حسب النوع</h3>
    <div class="h-full">
      <canvas id="kindsChart"></canvas>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="overflow-x-auto">
      <table class="w-full text-right border-collapse min-w-[800px]">
        <thead>
          <tr class="bg-gray-100 dark:bg-gray-800">
            <th class="p-2">النوع</th>
            <th class="p-2">المرجع</th>
            <th class="p-2">الفوّتشر</th>
            <th class="p-2">الموظف</th>
            <th class="p-2">العميل</th>
            <th class="p-2">تاريخ الإنشاء</th>
            <th class="p-2">تفاصيل</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr class="border-b border-gray-100 dark:border-gray-800">
            <td class="p-2">{{ r.kind }}</td>
            <td class="p-2">{{ r.ref }}</td>
            <td class="p-2">{{ r.voucher }}</td>
            <td class="p-2">{{ r.employee }}</td>
            <td class="p-2">{{ r.customer }}</td>
            <td class="p-2">{{ r.created|date:"Y-m-d H:i" }}</td>
            <td class="p-2">{{ r.extra }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="p-2 text-center text-gray-500 dark:text-gray-400">لا توجد بيانات</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Dark toggle
    const root = document.documentElement;
    document.getElementById('darkToggle').addEventListener('click', () => {
      root.classList.toggle('dark');
      try { localStorage.setItem('unibooking.dark', root.classList.contains('dark') ? '1' : '0'); } catch (e) {}
    });

    // Chart data from server
    const chartLabels = {{ chart_labels|safe }};
    const chartValues = {{ chart_values|safe }};

    new Chart(document.getElementById('kindsChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'عدد الحجوزات',
          data: chartValues,
          borderWidth: 1,
          backgroundColor: [
            'rgba(54, 162, 235, 0.5)',   // Hotel
            'rgba(255, 99, 132, 0.5)',   // Flight
            'rgba(255, 206, 86, 0.5)',   // Transfer
            'rgba(75, 192, 192, 0.5)'    // Visa
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)'
          ]
        }]
      },
      options: {
        maintainAspectRatio: false,
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    });
  </script>
</body>
</html>
