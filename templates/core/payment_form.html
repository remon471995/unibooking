{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="max-w-6xl mx-auto mt-10 space-y-8">

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø¯ÙØ¹ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white shadow rounded-xl p-6 text-center border">
            <p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±</p>
            <p class="text-2xl font-bold text-blue-600">{{ total_sell }} KWD</p>
        </div>
        <div class="bg-white shadow rounded-xl p-6 text-center border">
            <p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</p>
            <p class="text-2xl font-bold text-green-600">{{ total_paid }} KWD</p>
        </div>
        <div class="bg-white shadow rounded-xl p-6 text-center border">
            <p class="text-gray-500">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
            <p class="text-2xl font-bold text-red-600">{{ remaining }} KWD</p>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="bg-white shadow rounded-xl p-6 border">
        <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
            <i class="fas fa-chart-line text-indigo-500"></i>
            Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯
        </h2>
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden shadow-inner">
            <div class="bg-green-500 h-6 text-xs font-bold text-white flex items-center justify-center"
                 style="width: {{ progress }}%;">
                {{ progress }}%
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© -->
    <div class="bg-white shadow rounded-xl p-6 border">
        <h2 class="text-lg font-semibold text-gray-700 mb-6 flex items-center gap-2">
            <i class="fas fa-credit-card text-blue-500"></i>
            Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </h2>

        <form method="post" enctype="multipart/form-data" class="space-y-5">
            {% csrf_token %}

            <!-- Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹ -->
            <div>
                <label class="block mb-1 font-medium text-gray-700">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                {{ form.paid_amount|add_class:"w-full border rounded-lg p-2 focus:ring focus:ring-blue-200" }}
            </div>

            <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ -->
            <div>
                <label class="block mb-1 font-medium text-gray-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                {{ form.method|add_class:"w-full border rounded-lg p-2 focus:ring focus:ring-blue-200" }}
            </div>

            <!-- Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ -->
            <div id="payment-link-field" class="hidden">
                <label class="block mb-1 font-medium text-gray-700">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹</label>
                {{ form.payment_link|add_class:"w-full border rounded-lg p-2" }}
            </div>

            <!-- Ù…Ù„Ù Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ -->
            <div id="bank-file-field" class="hidden">
                <label class="block mb-1 font-medium text-gray-700">Ù…Ù„Ù Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ</label>
                {{ form.bank_file|add_class:"w-full border rounded-lg p-2 bg-gray-50" }}
            </div>

            <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø³Ø· -->
            <div id="installment-field" class="hidden">
                <label class="block mb-1 font-medium text-gray-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                {{ form.installment_date|add_class:"w-full border rounded-lg p-2" }}
            </div>

            <!-- Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <div>
                <label class="block mb-1 font-medium text-gray-700">ÙØ§ØªÙˆØ±Ø©</label>
                {{ form.invoice_file|add_class:"w-full border rounded-lg p-2 bg-gray-50" }}
            </div>

            <!-- Ø§Ù„ÙÙˆÙ‘ØªØ´Ø± Ø§Ù„Ø£ØµÙ„ÙŠ -->
            <div>
                <label class="block mb-1 font-medium text-gray-700">Ø§Ù„ÙÙˆÙ‘ØªØ´Ø± Ø§Ù„Ø£ØµÙ„ÙŠ</label>
                {{ form.voucher_original|add_class:"w-full border rounded-lg p-2 bg-gray-50" }}
            </div>

            <!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ -->
            <div class="text-right">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©
                </button>
            </div>
        </form>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
    <div class="bg-white shadow rounded-xl p-6 border">
        <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
            <i class="fas fa-list text-gray-500"></i>
            Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        </h2>

        {% if payments %}
            <div class="overflow-x-auto">
                <table class="w-full text-sm border-collapse border text-center">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th class="p-2 border">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                            <th class="p-2 border">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                            <th class="p-2 border">ÙØ§ØªÙˆØ±Ø©</th>
                            <th class="p-2 border">ÙÙˆÙ‘ØªØ´Ø±</th>
                            <th class="p-2 border">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pay in payments %}
                        <tr class="hover:bg-gray-50">
                            <td class="border p-2">{{ pay.paid_amount }}</td>
                            <td class="border p-2">{{ pay.get_method_display }}</td>
                            <td class="border p-2">{{ pay.installment_date|default:"-" }}</td>
                            <td class="border p-2">
                                {% if pay.invoice_file %}
                                    <a href="{{ pay.invoice_file.url }}" target="_blank" class="text-blue-600 hover:underline">ğŸ“„</a>
                                {% else %}-{% endif %}
                            </td>
                            <td class="border p-2">
                                {% if pay.voucher_original %}
                                    <a href="{{ pay.voucher_original.url }}" target="_blank" class="text-green-600 hover:underline">ğŸ“‘</a>
                                {% else %}-{% endif %}
                            </td>
                            <td class="border p-2">{{ pay.created_at|date:"Y-m-d H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</p>
        {% endif %}
    </div>
</div>

<!-- Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const methodField = document.getElementById("id_method");
    const paymentLink = document.getElementById("payment-link-field");
    const bankFile = document.getElementById("bank-file-field");
    const installmentField = document.getElementById("installment-field");

    function toggleFields() {
        const method = methodField.value;
        paymentLink.classList.add("hidden");
        bankFile.classList.add("hidden");
        installmentField.classList.add("hidden");

        if (method === "link") paymentLink.classList.remove("hidden");
        if (method === "bank") bankFile.classList.remove("hidden");
        if (method === "installment") installmentField.classList.remove("hidden");
    }

    methodField.addEventListener("change", toggleFields);
    toggleFields();
});
</script>
{% endblock %}
